<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FURUYUME STORE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f6f7f9 0%, #e3e6eb 100%);
            --text-color: #1a1a1a;
            --secondary-text: #8e8e93;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.8);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05); 
            --ios-bezier: cubic-bezier(0.25, 0.1, 0.25, 1);
            --accent-black: #1a1a1a;
            --error-color: #ff3b30;
            --success-color: #34c759;
            --warn-color: #FFD700;
            --sale-color: #ff3b30;
            --blue-link: #0077FF;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            padding-top: 10px;
        }

        button, input, select, textarea { font-family: inherit; }
        h1, h2, h3 { margin: 0; font-weight: 700; letter-spacing: -0.5px; }
        p { margin: 0; color: var(--secondary-text); }
        a { text-decoration: none; -webkit-tap-highlight-color: transparent; }

        /* REMOVE ARROWS FROM NUMBER INPUTS */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        /* --- NOTIFICATIONS --- */
        #notification-area {
            position: fixed; top: 20px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            z-index: 3000; pointer-events: none;
        }
        .notification-toast {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            padding: 14px 20px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            display: flex; align-items: center; gap: 12px;
            transform: translateY(-60px); opacity: 0;
            transition: all 0.4s var(--ios-bezier);
            font-size: 13px; font-weight: 600; color: #000;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .notification-toast.visible { transform: translateY(0); opacity: 1; }
        .notification-toast i { font-size: 16px; }
        .notification-toast.success i { color: var(--success-color); }
        .notification-toast.error i { color: var(--error-color); }
        .notification-toast.sale-toast i { color: var(--sale-color); }
        .notification-toast.original-toast i { color: var(--success-color); }

        /* --- PASSWORD STRENGTH --- */
        .strength-meter { display: flex; gap: 5px; margin-top: 10px; height: 4px; opacity: 0; transition: opacity 0.3s; }
        .strength-meter.visible { opacity: 1; }
        .strength-bar { flex: 1; background: #e0e0e0; border-radius: 2px; transition: background-color 0.3s ease; }
        .strength-weak .bar-1 { background-color: var(--error-color); }
        .strength-medium .bar-1, .strength-medium .bar-2 { background-color: var(--warn-color); }
        .strength-strong .bar-1, .strength-strong .bar-2, .strength-strong .bar-3 { background-color: var(--success-color); }

        /* --- UI ELEMENTS --- */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f6f7f9; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid #ddd; border-top: 3px solid #1a1a1a; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .loading-text { margin-top: 15px; font-size: 13px; font-weight: 500; color: #888; animation: pulse 1.5s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        #app-content { opacity: 0; transition: opacity 0.6s ease; }
        .page { display: none; padding: 20px; opacity: 0; transform: scale(0.98); transition: all 0.4s var(--ios-bezier); }
        .page.active { display: block; opacity: 1; transform: scale(1); }

        /* --- CATALOG --- */
        .catalog-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 0 5px; height: 44px; }
        .category-scroll { flex-grow: 1; overflow-x: auto; display: flex; gap: 10px; scrollbar-width: none; padding-right: 10px; height: 100%; align-items: center; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn { background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.05); padding: 10px 18px; border-radius: 20px; font-size: 13px; font-weight: 500; color: #666; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .cat-btn.active { background: #1a1a1a; color: white; font-weight: 600; border-color: #1a1a1a; }
        .header-cart-btn { flex-shrink: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: var(--glass-bg); border-radius: 14px; border: 1px solid var(--glass-border); color: #1a1a1a; font-size: 18px; cursor: pointer; box-shadow: var(--shadow); position: relative; }
        .header-cart-badge { position: absolute; top: -4px; right: -4px; background: #ff3b30; color: #fff; border-radius: 50%; min-width: 18px; height: 18px; padding: 0 4px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0); transition: all 0.3s; border: 2px solid #fff; }
        .header-cart-badge.visible { opacity: 1; transform: scale(1); }

        /* --- SLIDER --- */
        .slider-container { width: 100%; height: 180px; overflow: hidden; border-radius: 24px; margin-bottom: 25px; position: relative; box-shadow: var(--shadow); -webkit-mask-image: -webkit-radial-gradient(white, black); }
        .slider-wrapper { display: flex; width: 100%; height: 100%; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; scroll-behavior: smooth; }
        .slide { flex: 0 0 100%; scroll-snap-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; position: relative; background: var(--glass-bg); text-align: center; }
        .slide h3 { font-size: 20px; margin-bottom: 8px; color: #000; }
        .slide p { font-size: 14px; line-height: 1.4; color: #444; margin-bottom: 0; }
        .slide-content.has-btn p { margin-bottom: 15px; }
        .slider-btn { display: inline-block; background: #000; color: #fff; padding: 10px 24px; border-radius: 20px; text-decoration: none; font-size: 13px; font-weight: 600; border: 1px solid rgba(0,0,0,0.1); }

        /* --- HOME MENU --- */
        .home-menu { display: grid; gap: 14px; margin-top: 10px; }
        .home-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 22px; display: flex; align-items: center; justify-content: space-between; color: #1a1a1a; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.1s; }
        .home-btn:active { transform: scale(0.97); }
        .home-btn-content { display: flex; align-items: center; gap: 16px; }
        .home-btn-icon { width: 36px; height: 36px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #333; }
        .home-btn-text { font-size: 15px; font-weight: 600; }

        /* --- PRODUCTS --- */
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .product-card { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            border-radius: 22px; 
            padding: 12px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            position: relative; 
        }
        .product-card:active { transform: scale(0.98); transition: 0.2s; }
        
        .product-image { 
            width: 100%; 
            aspect-ratio: 1/1; 
            border-radius: 18px; 
            margin-bottom: 12px; 
            overflow: hidden; 
            position: relative; 
            background: transparent; 
        }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- BADGES (SALE ICON) --- */
        .card-badge { 
            position: absolute; top: 12px; left: 12px; 
            width: 32px; height: 32px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 14px; z-index: 10; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            cursor: pointer; transition: transform 0.2s; 
        }
        .card-badge:active { transform: scale(0.9); }
        .card-badge.sale { background: var(--sale-color); color: white; }

        /* --- BADGE (ORIGINAL TEXT) --- */
        .badge-text-original {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white;
            font-size: 9px; font-weight: 700; letter-spacing: 0.5px;
            text-transform: uppercase;
            padding: 5px 10px; border-radius: 8px;
            z-index: 10; backdrop-filter: blur(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* --- QUICK ADD BUTTON (Updated) --- */
        .card-quick-add { 
            width: 32px; height: 32px; 
            border-radius: 50%; 
            background: #f0f0f0; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 14px; color: #333; 
            cursor: pointer; transition: all 0.2s;
            margin-left: 8px;
        }
        .card-quick-add:active { transform: scale(0.9); background: #e0e0e0; color: #000; }

        /* --- PRODUCT DETAILS ALIGNMENT --- */
        .product-title { 
            font-size: 13px; font-weight: 600; line-height: 1.4; 
            margin-bottom: 6px; flex-grow: 1; color: #000; 
            padding: 0 4px;
            min-height: 36px; /* Fix height alignment */
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        
        .price-row { 
            display: flex; align-items: center; justify-content: space-between; 
            margin-bottom: 12px; padding: 0 4px; 
            height: 32px; /* Fixed height for row */
        }
        .price-container { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; }
        .product-price { font-size: 16px; font-weight: 700; color: #000; line-height: 1; }
        .old-price { font-size: 11px; color: #8e8e93; text-decoration: line-through; margin-top: 2px; }
        
        .add-btn { 
            width: 100%; padding: 12px 0; 
            background: #1a1a1a; color: white; 
            border: none; border-radius: 16px; 
            font-size: 13px; font-weight: 600; 
            cursor: pointer; 
        }

        /* --- CART --- */
        .cart-item { background: var(--glass-bg); border-radius: 20px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--glass-border); box-shadow: var(--shadow); transition: all 0.4s; overflow: hidden; }
        .cart-item.removing { opacity: 0; max-height: 0; margin: 0; padding: 0; border: none; transform: translateX(-20px); }
        .cart-item-img { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; margin-right: 14px; }
        .cart-item-details { display: flex; flex-direction: column; }
        .cart-item-name { font-weight: 600; font-size: 14px; margin-bottom: 2px;}
        .cart-item-info { font-size: 12px; color: #888; }
        .cart-item-price { font-size: 13px; color: #000; font-weight: 600; margin-top: 4px;}
        .total-block { margin-top: 25px; padding: 24px; background: white; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); text-align: center; transition: all 0.4s; }
        .total-block.hidden { opacity: 0; transform: translateY(20px); max-height: 0; margin: 0; padding: 0; }
        .checkout-btn { background: #000; color: white; width: 100%; padding: 18px; border-radius: 18px; font-size: 16px; font-weight: 600; margin-top: 15px; border: none; cursor: pointer; }

        /* --- AUTH & PROFILE --- */
        .profile-header-container { background: var(--glass-bg); border-radius: 26px; padding: 35px 20px; text-align: center; border: 1px solid var(--glass-border); margin-bottom: 25px; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .profile-avatar { width: 80px; height: 80px; background: #1a1a1a; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; }
        .auth-buttons-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 24px; }
        .auth-btn { padding: 16px; border-radius: 18px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: transform 0.1s; width: 100%; }
        .auth-btn.login { background: #1a1a1a; color: white; }
        .auth-btn.register { background: white; color: #1a1a1a; border: 1px solid rgba(0,0,0,0.1); }
        .auth-btn:active { transform: scale(0.96); }
        .profile-info-row { display: flex; justify-content: space-between; padding: 18px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 14px; }
        .profile-info-label { color: #8e8e93; font-weight: 500; }
        .profile-info-value { font-weight: 600; color: #1a1a1a; }
        .fc-badge { background: #FFD700; color: #000; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-left: 5px; }
        .profile-action-btn { margin-top: 20px; background: rgba(0,0,0,0.03); color: #1a1a1a; width: 100%; padding: 14px; border-radius: 16px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; }

        /* --- FORM INPUTS --- */
        .form-group { margin-bottom: 10px; text-align: left; }
        .form-label { display: block; font-size: 13px; color: #666; margin-bottom: 8px; font-weight: 500; padding-left: 5px; }
        .form-input { width: 100%; padding: 16px 18px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.08); background: #f9f9f9; font-size: 16px; transition: border 0.2s; -webkit-appearance: none; }
        .form-input:focus { border-color: #1a1a1a; background: #fff; }
        
        .checkbox-container { display: flex; align-items: center; gap: 10px; margin-top: 10px; font-size: 14px; cursor: pointer; }
        .checkbox-custom { width: 22px; height: 22px; border-radius: 6px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; background: white; transition: all 0.2s; }
        .checkbox-custom i { opacity: 0; transform: scale(0.5); transition: all 0.2s; color: white; }
        .checkbox-input { display: none; }
        .checkbox-input:checked + .checkbox-custom { background: #1a1a1a; border-color: #1a1a1a; }
        .checkbox-input:checked + .checkbox-custom i { opacity: 1; transform: scale(1); }

        /* --- MODALS (PROPORTIONAL FIXES) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 2000; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.4s; display: flex; align-items: center; justify-content: center; }
        .modal-overlay.open { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal { background: rgba(255,255,255,0.98); width: 88%; padding: 35px 25px; border-radius: 32px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.2); transform: scale(0.95) translateY(15px); opacity: 0; transition: all 0.4s var(--ios-bezier); position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal { transform: scale(1) translateY(0); opacity: 1; }
        .modal-btn { background: #000; color: white; padding: 16px 30px; border-radius: 18px; text-decoration: none; display: inline-block; margin-top: 20px; font-weight: 600; font-size: 16px; width: 100%; border: none; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .modal-btn.secondary { background: #0077FF; margin-top: 12px; }
        .close-modal { margin-top: 25px; display: block; color: #8e8e93; font-size: 15px; cursor: pointer; font-weight: 500; }

        /* --- DETAILS MODAL --- */
        .details-img-slider { width: 100%; height: 300px; overflow-x: auto; display: flex; scroll-snap-type: x mandatory; scrollbar-width: none; border-radius: 24px; margin-bottom: 25px; background: #fff; }
        .details-img-slide { flex: 0 0 100%; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; }
        .details-img-slide img { width: 100%; height: 100%; object-fit: contain; }
        
        .chips-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; margin-bottom: 20px; }
        .chip { padding: 10px 18px; border-radius: 14px; background: #f2f2f7; font-size: 14px; font-weight: 600; color: #666; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .chip.active { background: #1a1a1a; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .action-btn-small { background: white; border: 1px solid #eee; padding: 14px; border-radius: 16px; font-size: 13px; font-weight: 600; color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        
        /* --- TABLE STYLES --- */
        .size-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .size-table th, .size-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        .size-table th { font-weight: 600; color: #888; }
        
        /* --- MENU BTN STYLES --- */
        .profile-menu { display: flex; flex-direction: column; gap: 14px; }
        .menu-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .menu-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 22px; padding: 20px; display: flex; align-items: center; justify-content: space-between; color: #1a1a1a; box-shadow: var(--shadow); transition: transform 0.1s; }
        .menu-btn:active { transform: scale(0.97); }
        .menu-btn-left { display: flex; align-items: center; gap: 16px; }
        .menu-icon-box { width: 28px; display: flex; justify-content: center; align-items: center; }
        .menu-icon-box i { font-size: 22px; color: #333; }
        .menu-btn-text { font-size: 15px; font-weight: 600; letter-spacing: -0.2px; }
        .menu-btn.small { flex-direction: column; justify-content: center; text-align: center; gap: 12px; padding: 22px 12px; }
        .menu-btn.small .menu-icon-box { width: auto; }
        .menu-btn.small .menu-btn-text { font-size: 13px; }
        .menu-btn.contest { background: #1a1a1a; color: white; border: none; justify-content: space-between; align-items: center; }
        .contest-text { display: flex; flex-direction: column; text-align: left; }
        .contest-title { font-size: 16px; font-weight: 700; letter-spacing: 0.5px; }
        .contest-subtitle { font-size: 12px; opacity: 0.7; font-weight: 500; margin-top: 4px; }
        
        .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 400px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 30px; display: flex; justify-content: space-between; padding: 18px 24px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { color: #b0b0b0; text-align: center; cursor: pointer; transition: color 0.3s; position: relative; display: flex; align-items: center; justify-content: center; width: 25%; height: 100%; }
        .nav-item i { font-size: 26px; display: block; transition: transform 0.3s var(--ios-bezier); }
        .nav-item.active { color: #000; }
        .nav-item.active i { transform: translateY(-3px) scale(1.1); color: #000 !important; }
        .cart-badge { position: absolute; top: -6px; right: 10px; background: #ff3b30; color: #fff; border-radius: 50%; min-width: 20px; height: 20px; padding: 0 5px; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0); transition: all 0.3s; border: 2px solid white; }
        .cart-badge.visible { opacity: 1; transform: scale(1); }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="spinner"></div>
        <p class="loading-text">Загрузка...</p>
    </div>

    <div id="notification-area"></div>

    <div id="app-content">
        <div id="home" class="page active">
            <div class="slider-container" style="margin-top: 10px;">
                <div class="slider-wrapper" id="slider">
                    <div class="slide">
                        <div class="slide-content">
                            <h3>Сезонные скидки</h3>
                            <p>Скидки до 30% на новую коллекцию Adidas.</p>
                        </div>
                    </div>
                    <div class="slide">
                        <div class="slide-content has-btn">
                            <h3>Раздача в чате</h3>
                            <p>Ежедневно мы раздаем подарки в нашем чате Telegram.</p>
                            <a href="https://t.me/furuyumechat" target="_blank" class="slider-btn">Участвовать</a>
                        </div>
                    </div>
                    <div class="slide">
                        <div class="slide-content">
                            <h3>Быстрая отправка</h3>
                            <p>Отправляем заказы в течение 3 дней после оформления.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="home-menu">
                <div class="home-btn" onclick="openModal('support-modal')">
                    <div class="home-btn-content">
                        <div class="home-btn-icon"><i class="fas fa-headset"></i></div>
                        <span class="home-btn-text">Поддержка</span>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #ccc; font-size: 14px;"></i>
                </div>
                <div class="home-btn" onclick="openModal('how-to-order-modal')">
                    <div class="home-btn-content">
                        <div class="home-btn-icon"><i class="fas fa-info-circle"></i></div>
                        <span class="home-btn-text">Как оформить заказ?</span>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #ccc; font-size: 14px;"></i>
                </div>
                <div class="home-btn" onclick="switchTab('games', document.getElementById('nav-games'))">
                    <div class="home-btn-content">
                        <div class="home-btn-icon"><i class="fas fa-gift"></i></div>
                        <span class="home-btn-text">Подарок для тебя</span>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #ccc; font-size: 14px;"></i>
                </div>
            </div>
        </div>

        <div id="catalog" class="page">
            <div class="catalog-header">
                <div class="category-scroll">
                    <div class="cat-btn active" onclick="filterProducts('all', this)">Весь каталог</div>
                    <div class="cat-btn" onclick="filterProducts('olympiyka', this)">Олимпийки</div>
                    <div class="cat-btn" onclick="filterProducts('pants', this)">Штаны</div>
                    <div class="cat-btn" onclick="filterProducts('bomber', this)">Бомберы</div>
                </div>
                <div class="header-cart-btn" onclick="openCartPage()">
                    <i class="fas fa-shopping-bag"></i>
                    <div class="header-cart-badge" id="header-cart-badge">0</div>
                </div>
            </div>
            <div class="products-grid" id="products-container"></div>
        </div>

        <div id="games" class="page">
            <div class="games-placeholder" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:60vh; text-align:center; color:#8e8e93;">
                <i class="fas fa-gamepad games-icon" style="font-size:70px; margin-bottom:25px; opacity:0.3;"></i>
                <p style="font-size:18px; font-weight:600;">Раздел в разработке</p>
                <p style="font-size:14px; margin-top:8px;">Скоро здесь появятся мини-игры</p>
            </div>
        </div>

        <div id="profile" class="page">
            <div id="profile-content"></div>

            <div class="profile-menu">
                <a href="https://t.me/furuyumedelivery/9" target="_blank" class="menu-btn">
                    <div class="menu-btn-left">
                        <div class="menu-icon-box"><i class="fas fa-star" style="color: #FFD700;"></i></div>
                        <span class="menu-btn-text">ОТЗЫВЫ</span>
                    </div>
                    <i class="fas fa-chevron-right" style="font-size: 14px; color: #999;"></i>
                </a>
                <a href="https://t.me/furuyumechat" target="_blank" class="menu-btn">
                    <div class="menu-btn-left">
                        <div class="menu-icon-box"><i class="fas fa-comments"></i></div>
                        <span class="menu-btn-text">НАШ ЧАТ</span>
                    </div>
                    <i class="fas fa-chevron-right" style="font-size: 14px; color: #999;"></i>
                </a>
                <div class="menu-row">
                    <a href="https://t.me/furuyumedelivery/7" target="_blank" class="menu-btn small">
                        <div class="menu-icon-box"><i class="fas fa-shield-alt"></i></div>
                        <span class="menu-btn-text">ГАРАНТИИ</span>
                    </a>
                    <a href="https://t.me/furuyumedelivery/5" target="_blank" class="menu-btn small">
                        <div class="menu-icon-box"><i class="fas fa-file-contract"></i></div>
                        <span class="menu-btn-text">УСЛОВИЯ</span>
                    </a>
                </div>
                <a href="https://t.me/furuyumechat" target="_blank" class="menu-btn contest">
                    <div class="contest-text">
                        <span class="contest-title">ПОДАРКИ</span>
                        <span class="contest-subtitle">каждый день за пару легких действий</span>
                    </div>
                    <i class="fas fa-gift" style="font-size: 28px; opacity: 0.9;"></i>
                </a>
            </div>
        </div>

        <div id="cart-page" class="page">
            <div style="display: flex; align-items: center; margin-bottom: 25px;">
                <div onclick="switchTab('catalog', document.getElementById('nav-catalog'))" style="padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-arrow-left" style="font-size: 20px;"></i>
                    <span style="font-weight: 600; font-size: 15px;">Назад в каталог</span>
                </div>
            </div>
            <h2 style="margin-bottom: 25px; padding-left: 5px;">Корзина</h2>
            <div id="cart-items">
                <div style="text-align: center; margin-top: 80px; color: #8e8e93;">
                    <i class="fas fa-shopping-basket" style="font-size: 50px; margin-bottom: 20px; opacity: 0.3;"></i>
                    <p style="font-size: 15px;">Ваша корзина пуста</p>
                </div>
            </div>
            <div id="cart-total-block" class="total-block hidden">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 20px;">
                    <span>Итого:</span>
                    <span id="total-price" style="font-weight: 700;">0 ₽</span>
                </div>
                <button class="checkout-btn" onclick="openCheckoutModal()">Оформить заказ</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home', this)">
                <i class="fas fa-home"></i>
            </div>
            <div class="nav-item" id="nav-catalog" onclick="switchTab('catalog', this)">
                <i class="fas fa-tshirt"></i>
            </div>
            <div class="nav-item" id="nav-games" onclick="switchTab('games', this)">
                <i class="fas fa-gamepad"></i>
            </div>
            <div class="nav-item" onclick="switchTab('profile', this)">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="product-details-modal">
        <div class="modal" style="padding: 25px; text-align: left;">
            <div id="details-content"></div>
            <span class="close-modal" onclick="closeModal('product-details-modal')" style="text-align: center; margin-top: 15px;">Закрыть</span>
        </div>
    </div>

    <div class="modal-overlay" id="size-chart-modal">
        <div class="modal">
            <h3>Размерная сетка</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 20px;">Поскольку изделия выполнены в оверсайз-крое, для выбора достаточно ориентироваться на рост.</p>
            
            <table class="size-table">
                <thead>
                    <tr>
                        <th>Размер</th>
                        <th>Рост (см)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>S</td><td>160 - 170</td></tr>
                    <tr><td>M</td><td>170 - 180</td></tr>
                    <tr><td>L</td><td>180 - 185</td></tr>
                    <tr><td>XL</td><td>185 - 195</td></tr>
                </tbody>
            </table>

            <button class="modal-btn" onclick="closeModal('size-chart-modal'); openModal('product-details-modal')">Назад к товару</button>
        </div>
    </div>

    <div class="modal-overlay" id="real-photos-modal">
        <div class="modal">
            <h3 style="margin-bottom: 20px;">Живые фото</h3>
            <div class="details-img-slider" id="real-photos-slider">
                </div>
            <p style="font-size: 13px; color:#999; margin-top:10px;">Листайте вправо</p>
            <button class="modal-btn" onclick="closeModal('real-photos-modal'); openModal('product-details-modal')">Назад к товару</button>
        </div>
    </div>

    <div class="modal-overlay" id="register-modal">
        <div class="modal">
            <h3>Регистрация</h3>
            <p style="margin-bottom: 25px;">Создайте аккаунт</p>
            
            <div id="reg-step-1">
                <div class="form-group">
                    <label class="form-label">Логин</label>
                    <input type="text" class="form-input" id="reg-login" maxlength="12" placeholder="Придумайте логин">
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="reg-pass" placeholder="Придумайте пароль">
                    <div class="strength-meter" id="pass-strength">
                        <div class="strength-bar bar-1"></div>
                        <div class="strength-bar bar-2"></div>
                        <div class="strength-bar bar-3"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Повторите пароль</label>
                    <input type="password" class="form-input" id="reg-pass-repeat" placeholder="Повторите пароль">
                </div>
                <button class="modal-btn" onclick="regNextStep()">Продолжить</button>
            </div>

            <div id="reg-step-2" style="display: none;">
                <p style="margin-bottom: 20px; color: #1a1a1a;">Мы отправили код подтверждения в наш бот.</p>
                <div class="form-group">
                    <label class="form-label">Введите код</label>
                    <input type="number" class="form-input" id="reg-code" placeholder="1234" style="text-align: center; letter-spacing: 4px; font-weight: 600;">
                </div>
                <button class="modal-btn" onclick="finishRegistration()">Подтвердить</button>
            </div>

            <span class="close-modal" onclick="closeModal('register-modal')">Отмена</span>
        </div>
    </div>

    <div class="modal-overlay" id="login-modal">
        <div class="modal">
            <h3>Вход</h3>
            <p style="margin-bottom: 25px;">С возвращением!</p>
            
            <div id="login-step-1">
                <div class="form-group">
                    <label class="form-label">Логин</label>
                    <input type="text" class="form-input" id="login-username" placeholder="Ваш логин">
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="login-pass" placeholder="••••••">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <label class="checkbox-container" style="margin-top:0;">
                        <input type="checkbox" class="checkbox-input" id="remember-me">
                        <div class="checkbox-custom"><i class="fas fa-check" style="font-size: 12px;"></i></div>
                        <span>Запомнить меня</span>
                    </label>
                    <a href="#" onclick="openForgotPass()" style="font-size: 13px; color: #0077FF; font-weight: 500;">Забыли пароль?</a>
                </div>
                <button class="modal-btn" onclick="performLogin()">Войти</button>
            </div>

            <div id="login-step-2" style="display: none;">
                <p style="margin-bottom: 20px;">Введите код из бота для входа</p>
                <div class="form-group">
                    <input type="number" class="form-input" id="login-code" placeholder="1234" style="text-align: center; letter-spacing: 4px; font-weight: 600;">
                </div>
                <button class="modal-btn" onclick="verifyLogin()">Подтвердить</button>
            </div>

            <span class="close-modal" onclick="closeModal('login-modal')">Закрыть</span>
        </div>
    </div>

    <div class="modal-overlay" id="forgot-pass-modal">
        <div class="modal">
            <h3>Восстановление</h3>
            
            <div id="forgot-step-1">
                <p style="margin-bottom: 20px;">Введите ваш логин</p>
                <div class="form-group">
                    <input type="text" class="form-input" id="forgot-login" placeholder="Логин">
                </div>
                <button class="modal-btn" onclick="requestResetCode()">Отправить код</button>
            </div>

            <div id="forgot-step-2" style="display: none;">
                <p style="margin-bottom: 15px;">Код отправлен в бот</p>
                <div class="form-group">
                    <label class="form-label">Код</label>
                    <input type="number" class="form-input" id="reset-code" placeholder="1234" style="text-align: center; letter-spacing: 4px; font-weight: 600;">
                </div>
                <div class="form-group">
                    <label class="form-label">Новый пароль</label>
                    <input type="password" class="form-input" id="reset-new-pass" placeholder="">
                </div>
                <div class="form-group">
                    <label class="form-label">Повторите пароль</label>
                    <input type="password" class="form-input" id="reset-new-pass-rep">
                </div>
                <button class="modal-btn" onclick="finishResetPass()">Сменить пароль</button>
            </div>

            <span class="close-modal" onclick="closeModal('forgot-pass-modal')">Отмена</span>
        </div>
    </div>

    <div class="modal-overlay" id="profile-details-modal">
        <div class="modal">
            <h3 style="margin-bottom: 25px;">Мой профиль</h3>
            
            <div class="profile-info-row">
                <span class="profile-info-label">Логин:</span>
                <span class="profile-info-value" id="details-login">Guest</span>
            </div>
            <div class="profile-info-row">
                <span class="profile-info-label">Баланс:</span>
                <span class="profile-info-value" id="details-fc">0 <span class="fc-badge">FC</span></span>
            </div>
            <div class="profile-info-row">
                <span class="profile-info-label">Telegram ID:</span>
                <span class="profile-info-value" id="details-tg-id">Hidden</span>
            </div>

            <button class="profile-action-btn" onclick="openChangePassword()">Сменить пароль</button>
            <button class="profile-action-btn" style="color: #ff3b30;" onclick="logout()">Выйти из аккаунта</button>

            <span class="close-modal" onclick="closeModal('profile-details-modal')">Закрыть</span>
        </div>
    </div>

    <div class="modal-overlay" id="change-pass-modal">
        <div class="modal">
            <h3>Смена пароля</h3>
            <div id="change-pass-step-1">
                <p style="margin-bottom: 20px;">Мы отправили код подтверждения</p>
                <div class="form-group">
                    <label class="form-label">Код из бота</label>
                    <input type="number" class="form-input" id="change-code" placeholder="1234" style="text-align: center; letter-spacing: 4px; font-weight: 600;">
                </div>
                <div class="form-group">
                    <label class="form-label">Новый пароль</label>
                    <input type="password" class="form-input" id="change-new-pass" placeholder="">
                </div>
                <div class="form-group">
                    <label class="form-label">Повторите пароль</label>
                    <input type="password" class="form-input" id="change-new-pass-rep">
                </div>
                <button class="modal-btn" onclick="submitProfilePassChange()">Сменить</button>
            </div>
            <span class="close-modal" onclick="closeModal('change-pass-modal')">Отмена</span>
        </div>
    </div>

    <div class="modal-overlay" id="checkout-modal">
        <div class="modal">
            <i class="fas fa-check-circle" style="font-size: 60px; margin-bottom: 25px; color: #1a1a1a;"></i>
            <h3>Готово к заказу</h3>
            <p style="margin-top: 12px; font-size: 16px;">Отправьте список товаров менеджеру, чтобы завершить покупку.</p>
            <a href="#" id="order-link" target="_blank" class="modal-btn">Написать @furuyumeorders</a>
            <span class="close-modal" onclick="closeModal('checkout-modal')">Вернуться назад</span>
        </div>
    </div>

    <div class="modal-overlay" id="support-modal">
        <div class="modal">
            <i class="fas fa-headset" style="font-size: 50px; margin-bottom: 25px; color: #333;"></i>
            <h3>Поддержка</h3>
            <p style="margin-top: 12px; font-size: 15px; line-height: 1.5;">Если у вас возникли вопросы, нажмите кнопку ниже, чтобы перейти в диалог.</p>
            <a href="https://t.me/furuyumemngrs" target="_blank" class="modal-btn">Перейти</a>
            <span class="close-modal" onclick="closeModal('support-modal')">Закрыть</span>
        </div>
    </div>

    <div class="modal-overlay" id="how-to-order-modal">
        <div class="modal">
            <i class="fas fa-clipboard-list" style="font-size: 50px; margin-bottom: 25px; color: #333;"></i>
            <h3>Как заказать?</h3>
            <p style="margin-top: 12px; font-size: 15px; line-height: 1.6; text-align: left;">
                1. Перейдите в раздел <b>Каталог</b>.<br>
                2. Выберите модель, цвет и размер.<br>
                3. Добавьте в корзину или нажмите "Заказать".<br>
            </p>
            <button class="modal-btn" onclick="closeModal('how-to-order-modal'); switchTab('catalog', document.getElementById('nav-catalog'));">Перейти в Каталог</button>
            <span class="close-modal" onclick="closeModal('how-to-order-modal')">Закрыть</span>
        </div>
    </div>

    <div class="modal-overlay" id="product-info-modal">
        <div class="modal">
            <h3 id="info-modal-title" style="margin-bottom: 15px;">Товар</h3>
            <p style="font-size: 15px; color: #444; line-height: 1.5;">Подробную информацию о товаре вы можете уточнить у менеджера.</p>
            <a href="https://t.me/furuyumeorders" target="_blank" class="modal-btn">Написать @furuyumeorders</a>
            <span class="close-modal" onclick="closeModal('product-info-modal')">Закрыть</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 
        tg.setHeaderColor('secondary_bg_color'); 
        tg.setBackgroundColor('secondary_bg_color');

        const BACKEND_URL = "https://furuyume.online/api";

        // DATA: Products with full info
        const products = [
            { 
                id: 1, 
                name: "Adidas Japan track jacket", 
                category: "olympiyka", 
                price: 3000, 
                oldPrice: 11800, 
                image: "japan.png",
                isSale: true,
                sizes: ['S', 'M'],
                description: "Самая редкая олимпийка от Адидас с пометкой винтаж. Лучшая реплика на рынке.",
                realPhotos: ['real_japan_1.jpg', 'real_japan_2.jpg', 'real_japan_3.jpg', 'real_japan_4.jpg', 'real_japan_5.jpg']
            },
            { 
                id: 2, 
                name: "Adidas x Yohji Yamamoto", 
                category: "olympiyka", 
                price: 4200, 
                oldPrice: 13400, 
                image: "yamamoto.png",
                isSale: true,
                sizes: ['S', 'M', 'L', 'XL'],
                description: "Эксклюзивная коллаборация Adidas и Yohji Yamamoto. Лучшая реплика на рынке.",
                colors: [
                    { name: "Белая с бирюзовым", image: "yamamoto_white_turq.png", id: "yama_1" },
                    { name: "Белая с черным", image: "yamamoto_white_black.png", id: "yama_2" }
                ],
                realPhotos: ['real_yamamoto_1.jpg', 'real_yamamoto_2.jpg', 'real_yamamoto_3.jpg', 'real_yamamoto_4.jpg', 'real_yamamoto_5.jpg']
            },
            { 
                id: 3, 
                name: "Adidas Chinese jacket", 
                category: "olympiyka", 
                price: 5700, 
                isOriginal: true,
                image: "china.png",
                sizes: ['S', 'M', 'L', 'XL'],
                description: "Оригинальная олимпийка из китайской коллекции Adidas. Яркие цвета, оверсайз крой.",
                colors: [
                    { name: "Белый", image: "china_white.png", id: "chi_1" },
                    { name: "Синий", image: "china_blue.png", id: "chi_2" },
                    { name: "Желтый", image: "china_yellow.png", id: "chi_3" },
                    { name: "Красный", image: "china_red.png", id: "chi_4" }
                ],
                realPhotos: ['real_china_1.jpg', 'real_china_2.jpg', 'real_china_3.jpg', 'real_china_4.jpg', 'real_china_5.jpg']
            },
            { 
                id: 4, 
                name: "VETEMENTS maroon bomber", 
                category: "bomber", 
                price: 13200, 
                oldPrice: 20500, 
                image: "vetements.png",
                sizes: ['S', 'M', 'L', 'XL'],
                description: "Бомбер VETEMENTS. Тяжелый люкс, премиум качество. Лучшая реплика на рынке.",
                realPhotos: ['real_vetements_1.jpg', 'real_vetements_2.jpg', 'real_vetements_3.jpg', 'real_vetements_4.jpg', 'real_vetements_5.jpg']
            }
        ];

        // --- AUTH LOGIC ---
        function validateInput(text, type) {
            if (type === 'login') return /^[a-zA-Z0-9]{4,12}$/.test(text);
            if (type === 'password') return text.length > 0;
            return false;
        }

        function checkPassStrength(password) {
            const meter = document.getElementById('pass-strength');
            if (password.length === 0) { meter.classList.remove('visible'); return; }
            meter.classList.add('visible');
            let score = 0;
            if (password.length > 4) score++;
            if (password.length > 8) score++;
            if (/[0-9]/.test(password) && /[a-zA-Z]/.test(password)) score++;
            meter.className = 'strength-meter visible ' + (score <= 1 ? 'strength-weak' : score === 2 ? 'strength-medium' : 'strength-strong');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const regPassInput = document.getElementById('reg-pass');
            if(regPassInput) regPassInput.addEventListener('input', (e) => checkPassStrength(e.target.value));
        });

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type === 'sale' ? 'sale-toast' : type === 'original' ? 'original-toast' : type}`;
            let icon = type === 'error' ? 'fa-exclamation-circle' : type === 'sale' ? 'fa-fire' : type === 'original' ? 'fa-check' : 'fa-check-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.add('visible'); });
            setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 400); }, 3000);
            if(tg.HapticFeedback) type === 'error' ? tg.HapticFeedback.notificationOccurred('error') : tg.HapticFeedback.notificationOccurred('success');
        }

        let currentUser = null; 
        let tempRegData = {};
        let tempLoginData = {};

        function checkAuth() {
            const r = localStorage.getItem('furuyume_user_data');
            const s = sessionStorage.getItem('furuyume_user_data');
            if (r) currentUser = JSON.parse(r);
            else if (s) currentUser = JSON.parse(s);
            renderProfile();
        }

        function renderProfile() {
            const container = document.getElementById('profile-content');
            if (currentUser) {
                container.innerHTML = `
                    <div class="profile-header-container">
                        <div class="profile-avatar"><i class="fas fa-user"></i></div>
                        <h3 style="margin-bottom: 5px;">${currentUser.login}</h3>
                        <p style="font-size: 13px; margin-bottom: 15px;">Профиль</p>
                        <button class="modal-btn" style="margin-top:0;" onclick="openModal('profile-details-modal')">Открыть профиль</button>
                    </div>`;
                document.getElementById('details-login').innerText = currentUser.login;
                document.getElementById('details-fc').innerHTML = `${currentUser.fc} <span class="fc-badge">FC</span>`;
                document.getElementById('details-tg-id').innerText = currentUser.tg_id || "Скрыт";
            } else {
                container.innerHTML = `
                    <div class="profile-header-container">
                        <div class="profile-avatar" style="background: #f0f0f0; color: #ccc;"><i class="fas fa-user-slash"></i></div>
                        <h3 style="margin-bottom: 5px;">Личный кабинет</h3>
                        <p style="font-size: 13px;">Войдите или создайте аккаунт</p>
                        <div class="auth-buttons-grid">
                            <button class="auth-btn login" onclick="openModal('login-modal')">Войти</button>
                            <button class="auth-btn register" onclick="openModal('register-modal')">Регистрация</button>
                        </div>
                    </div>`;
            }
        }

        async function regNextStep() {
            const login = document.getElementById('reg-login').value;
            const pass = document.getElementById('reg-pass').value;
            const passRep = document.getElementById('reg-pass-repeat').value;
            if (!validateInput(login, 'login')) return showNotification('Логин: 4-12 лат. букв/цифр', 'error');
            if (pass.length < 1) return showNotification('Введите пароль', 'error');
            if (pass !== passRep) return showNotification('Пароли не совпадают', 'error');
            const tg_id = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
            if(!tg_id) return showNotification('Зайдите через Telegram!', 'error');

            try {
                const res = await fetch(`${BACKEND_URL}/send_code`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ tg_id, action: 'register' }) });
                const data = await res.json();
                if(data.status === 'success') {
                    tempRegData = { login, pass, tg_id };
                    document.getElementById('reg-step-1').style.display = 'none';
                    document.getElementById('reg-step-2').style.display = 'block';
                    showNotification('Код отправлен!', 'success');
                } else showNotification(data.message, 'error');
            } catch (e) { showNotification('Ошибка сети', 'error'); }
        }

        async function finishRegistration() {
            const code = document.getElementById('reg-code').value;
            if(!code) return showNotification('Введите код', 'error');
            try {
                const res = await fetch(`${BACKEND_URL}/register`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ...tempRegData, code }) });
                const data = await res.json();
                if(data.status === 'success') {
                    currentUser = { login: tempRegData.login, fc: 0, tg_id: tempRegData.tg_id };
                    localStorage.setItem('furuyume_user_data', JSON.stringify(currentUser));
                    closeModal('register-modal'); renderProfile(); showNotification('Успешно!', 'success');
                    document.getElementById('reg-step-1').style.display = 'block'; document.getElementById('reg-step-2').style.display = 'none';
                } else showNotification(data.message, 'error');
            } catch (e) { showNotification('Ошибка сети', 'error'); }
        }

        async function performLogin() {
            const login = document.getElementById('login-username').value;
            const pass = document.getElementById('login-pass').value;
            if(!login || !pass) return showNotification('Заполните поля', 'error');
            try {
                const res = await fetch(`${BACKEND_URL}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ login, pass }) });
                const data = await res.json();
                if(data.status === '2fa_required') {
                    tempLoginData = { tg_id: data.tg_id };
                    document.getElementById('login-step-1').style.display = 'none';
                    document.getElementById('login-step-2').style.display = 'block';
                    showNotification('Введите код', 'success');
                } else showNotification(data.message || 'Ошибка', 'error');
            } catch (e) { showNotification('Ошибка сети', 'error'); }
        }

        async function verifyLogin() {
            const code = document.getElementById('login-code').value;
            if(!code) return showNotification('Введите код', 'error');
            const remember = document.getElementById('remember-me').checked;
            try {
                const res = await fetch(`${BACKEND_URL}/verify_login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ tg_id: tempLoginData.tg_id, code }) });
                const data = await res.json();
                if(data.status === 'success') {
                    currentUser = data.user;
                    if (remember) localStorage.setItem('furuyume_user_data', JSON.stringify(currentUser));
                    else sessionStorage.setItem('furuyume_user_data', JSON.stringify(currentUser));
                    closeModal('login-modal'); renderProfile(); showNotification('Успешный вход!', 'success');
                    document.getElementById('login-step-1').style.display = 'block'; document.getElementById('login-step-2').style.display = 'none';
                } else showNotification(data.message, 'error');
            } catch (e) { showNotification('Ошибка сети', 'error'); }
        }

        function openForgotPass() { closeModal('login-modal'); openModal('forgot-pass-modal'); if(currentUser) document.getElementById('forgot-login').value = currentUser.login; }
        
        async function requestResetCode() {
            const login = document.getElementById('forgot-login').value;
            if(!login) return showNotification('Введите логин', 'error');
            try {
                const res = await fetch(`${BACKEND_URL}/forgot_request`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ login }) });
                const data = await res.json();
                if(data.status === 'success') {
                    tempLoginData = { tg_id: data.tg_id };
                    document.getElementById('forgot-step-1').style.display = 'none'; document.getElementById('forgot-step-2').style.display = 'block';
                    showNotification('Код отправлен!', 'success');
                } else showNotification(data.message, 'error');
            } catch (e) { showNotification('Ошибка сети', 'error'); }
        }

        async function finishResetPass() {
            const code = document.getElementById('reset-code').value; const newPass = document.getElementById('reset-new-pass').value; const rep = document.getElementById('reset-new-pass-rep').value;
            if(!code) return showNotification('Введите код', 'error'); if(newPass.length < 1) return showNotification('Пароль пуст', 'error'); if(newPass !== rep) return showNotification('Не совпадают', 'error');
            try {
                const res = await fetch(`${BACKEND_URL}/reset_pass`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ tg_id: tempLoginData.tg_id, code, new_pass: newPass }) });
                const data = await res.json();
                if(data.status === 'success') { showNotification('Пароль изменен!', 'success'); closeModal('forgot-pass-modal'); openModal('login-modal'); } else showNotification(data.message, 'error');
            } catch (e) { showNotification('Ошибка сети', 'error'); }
        }

        function logout() { localStorage.removeItem('furuyume_user_data'); sessionStorage.removeItem('furuyume_user_data'); currentUser = null; closeModal('profile-details-modal'); renderProfile(); showNotification('Вы вышли', 'success'); }

        async function openChangePassword() {
            closeModal('profile-details-modal');
            if(!currentUser) return;
            try {
                const res = await fetch(`${BACKEND_URL}/send_code`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ tg_id: currentUser.tg_id, action: 'change_pass' }) });
                const data = await res.json();
                if(data.status === 'success') { showNotification('Код отправлен', 'success'); openModal('change-pass-modal'); } else showNotification(data.message, 'error');
            } catch (e) { showNotification('Ошибка сети', 'error'); }
        }

        async function submitProfilePassChange() {
            const code = document.getElementById('change-code').value; const newPass = document.getElementById('change-new-pass').value; const rep = document.getElementById('change-new-pass-rep').value;
            if(!code) return showNotification('Код?', 'error'); if(newPass.length < 1) return showNotification('Пароль?', 'error'); if(newPass !== rep) return showNotification('Не совпадают', 'error');
            try {
                const res = await fetch(`${BACKEND_URL}/change_pass_profile`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ tg_id: currentUser.tg_id, code, new_pass: newPass }) });
                const data = await res.json();
                if(data.status === 'success') { showNotification('Изменено!', 'success'); closeModal('change-pass-modal'); } else showNotification(data.message, 'error');
            } catch (e) { showNotification('Ошибка сети', 'error'); }
        }

        // --- CATALOG & LOGIC UPDATE ---
        let cart = [];
        let currentCategory = 'all';
        let currentSelectedProduct = null;
        let selectedSize = null;
        let selectedColor = null;

        function filterProducts(category, btnElement) {
            currentCategory = category;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            renderProducts();
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function renderProducts() {
            const container = document.getElementById('products-container');
            const filtered = currentCategory === 'all' ? products : products.filter(p => p.category === currentCategory);
            
            if (filtered.length === 0) { container.innerHTML = `<div style="grid-column: 1/-1; text-align: center; margin-top: 40px; color: #999;">Пусто</div>`; return; }

            container.innerHTML = filtered.map(p => {
                let badge = '';
                if(p.isSale) badge = `<div class="card-badge sale" onclick="event.stopPropagation(); showNotification('Товар на распродаже', 'sale')"><i class="fas fa-fire"></i></div>`;
                
                // --- ORIGINAL BADGE LOGIC (TEXT BADGE) ---
                let originalBadge = '';
                if(p.isOriginal) originalBadge = `<div class="badge-text-original" onclick="event.stopPropagation(); showNotification('Оригинальный товар', 'original')">ОРИГИНАЛ</div>`;

                return `
                <div class="product-card">
                    ${badge}
                    ${originalBadge}
                    <div class="product-image" onclick="openDetails(${p.id})">
                        <img src="${p.image}" alt="${p.name}">
                    </div>
                    <div class="product-title">${p.name}</div>
                    <div class="price-row">
                        <div class="price-container">
                            <div class="product-price">${p.price} ₽</div>
                            ${p.oldPrice ? `<div class="old-price">${p.oldPrice} ₽</div>` : ''}
                        </div>
                        <div class="card-quick-add" onclick="event.stopPropagation(); openDetails(${p.id})"><i class="fas fa-plus"></i></div>
                    </div>
                    <button class="add-btn" onclick="openDetails(${p.id})">Подробнее</button>
                </div>
            `}).join('');
        }

        function openDetails(id) {
            const p = products.find(prod => prod.id === id);
            currentSelectedProduct = p;
            selectedSize = null;
            selectedColor = null;
            
            // Build Color Options
            let colorsHtml = '';
            if(p.colors) {
                colorsHtml = `<p style="font-weight:600; font-size:13px; margin-bottom:8px;">Цвет:</p>
                <div class="chips-container">
                    ${p.colors.map(c => `<div class="chip" onclick="selectColor(this, '${c.name}', '${c.image}')">${c.name}</div>`).join('')}
                </div>`;
            }

            // Build Size Options
            let sizesHtml = `<p style="font-weight:600; font-size:13px; margin-bottom:8px;">Размер:</p>
            <div class="chips-container">
                ${p.sizes.map(s => `<div class="chip" onclick="selectSize(this, '${s}')">${s}</div>`).join('')}
            </div>`;

            // Slider Images (Main + Real placeholders if simple)
            // For the main slider, we just use the main image + colors if available
            let sliderHtml = `<div class="details-img-slide"><img id="detail-main-img" src="${p.image}"></div>`;

            const content = `
                <div class="details-img-slider">${sliderHtml}</div>
                <h3 style="margin-bottom: 5px;">${p.name}</h3>
                <div style="font-size: 18px; font-weight: 700; margin-bottom: 15px;">${p.price} ₽</div>
                
                ${sizesHtml}
                ${colorsHtml}

                <div class="action-grid">
                    <div class="action-btn-small" onclick="closeModal('product-details-modal'); openModal('size-chart-modal')"><i class="fas fa-ruler"></i> Размерная сетка</div>
                    <div class="action-btn-small" onclick="openRealPhotos()"><i class="fas fa-camera"></i> Реальные фото</div>
                </div>

                <p style="margin-top: 20px; font-size: 14px; line-height: 1.5; color: #444;">${p.description}</p>

                <div style="margin-top: 8px; display: grid; gap: 1px;">
                    <button class="modal-btn" onclick="addToCartDetail()">Добавить в корзину</button>
                    <button class="modal-btn secondary" onclick="orderNowDetail()">Заказать сейчас</button>
                </div>
            `;
            
            document.getElementById('details-content').innerHTML = content;
            openModal('product-details-modal');
        }

        function selectSize(el, size) {
            document.querySelectorAll('#details-content .chip').forEach(c => { 
                if(['S','M','L','XL'].includes(c.innerText)) c.classList.remove('active'); 
            });
            el.classList.add('active');
            selectedSize = size;
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function selectColor(el, name, img) {
            // Remove active from other colors
            const container = el.parentElement;
            container.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedColor = name;
            document.getElementById('detail-main-img').src = img;
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function openRealPhotos() {
            const p = currentSelectedProduct;
            const slider = document.getElementById('real-photos-slider');
            if(p.realPhotos && p.realPhotos.length > 0) {
                slider.innerHTML = p.realPhotos.map(url => `<div class="details-img-slide"><img src="${url}" onerror="this.src='${p.image}'"></div>`).join('');
                closeModal('product-details-modal');
                openModal('real-photos-modal');
            } else {
                showNotification('Фото загружаются', 'info');
            }
        }

        function addToCartDetail() {
            if(!selectedSize) return showNotification('Выберите размер', 'error');
            if(currentSelectedProduct.colors && !selectedColor) return showNotification('Выберите цвет', 'error');
            
            const item = {
                ...currentSelectedProduct,
                cartId: Date.now() + Math.random(),
                selectedSize: selectedSize,
                selectedColor: selectedColor,
                // Display specific image if color selected
                displayImage: selectedColor ? currentSelectedProduct.colors.find(c => c.name === selectedColor).image : currentSelectedProduct.image
            };
            cart.push(item);
            closeModal('product-details-modal');
            updateCartUI();
            showNotification('Добавлено в корзину', 'success');
        }

        function orderNowDetail() {
            if(!selectedSize) return showNotification('Выберите размер', 'error');
            if(currentSelectedProduct.colors && !selectedColor) return showNotification('Выберите цвет', 'error');
            
            const p = currentSelectedProduct;
            const text = `Здравствуйте! Хочу заказать:\n\n${p.name}\nРазмер: ${selectedSize}\n${selectedColor ? 'Цвет: '+selectedColor : ''}\nЦена: ${p.price} ₽`;
            window.location.href = `https://t.me/furuyumeorders?text=${encodeURIComponent(text)}`;
        }

        function updateCartUI() {
            const headerBadge = document.getElementById('header-cart-badge');
            const cartNavBadge = document.getElementById('cart-badge');
            const count = cart.length;
            [headerBadge, cartNavBadge].forEach(el => {
                if(el) { el.innerText = count; if (count > 0) el.classList.add('visible'); else el.classList.remove('visible'); }
            });

            const container = document.getElementById('cart-items');
            const totalBlock = document.getElementById('cart-total-block');
            const totalEl = document.getElementById('total-price');
            const total = cart.reduce((sum, item) => sum + item.price, 0);

            if (cart.length === 0) {
                totalBlock.classList.add('hidden');
                if (!window.isRemoving) container.innerHTML = `<div style="text-align: center; margin-top: 60px; color: #8e8e93;"><i class="fas fa-shopping-basket" style="font-size: 40px; margin-bottom: 15px; opacity: 0.3;"></i><p>Ваша корзина пуста</p></div>`;
            } else {
                totalBlock.classList.remove('hidden');
                totalEl.innerText = total + ' ₽';
                if (!window.isRemoving) {
                    container.innerHTML = cart.map(item => `
                        <div class="cart-item" id="cart-item-${item.cartId}">
                            <div style="display:flex; align-items:center;">
                                <img src="${item.displayImage || item.image}" class="cart-item-img">
                                <div class="cart-item-details">
                                    <div class="cart-item-name">${item.name}</div>
                                    <div class="cart-item-info">${item.selectedSize} ${item.selectedColor ? '| ' + item.selectedColor : ''}</div>
                                    <div class="cart-item-price">${item.price} ₽</div>
                                </div>
                            </div>
                            <div onclick="removeFromCart('${item.cartId}')" style="padding: 10px; cursor: pointer;"><i class="fas fa-times" style="color: #ccc;"></i></div>
                        </div>
                    `).join('');
                }
            }
        }

        window.isRemoving = false;
        function removeFromCart(cartId) {
            window.isRemoving = true;
            const el = document.getElementById(`cart-item-${cartId}`);
            if (el) {
                el.classList.add('removing');
                setTimeout(() => {
                    const idx = cart.findIndex(i => i.cartId == cartId);
                    if (idx > -1) cart.splice(idx, 1);
                    window.isRemoving = false;
                    updateCartUI();
                }, 400);
            }
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function openCheckoutModal() {
            const modalOverlay = document.getElementById('checkout-modal');
            const orderLinkBtn = document.getElementById('order-link');
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            let message = "Здравствуйте! Хочу оформить заказ:\n\n";
            cart.forEach((item, index) => {
                message += `${index + 1}. ${item.name} (Р-р: ${item.selectedSize}${item.selectedColor ? ', '+item.selectedColor : ''}) — ${item.price} ₽\n`;
            });
            message += `\n💰 Итого: ${total} ₽`;
            orderLinkBtn.href = `https://t.me/furuyumeorders?text=${encodeURIComponent(message)}`;
            modalOverlay.classList.add('open');
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged(); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function switchTab(id, el) { 
            if(!el) { if(id==='catalog') el=document.getElementById('nav-catalog'); if(id==='games') el=document.getElementById('nav-games'); }
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); if(el) el.classList.add('active');
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }
        function openCartPage() { switchTab('cart-page'); document.getElementById('cart-page').classList.add('active'); }

        const slider = document.getElementById('slider');
        let slideIndex = 0;
        setInterval(() => {
            slideIndex++;
            if (slideIndex >= 3) { slideIndex = 0; slider.scrollTo({ left: 0, behavior: 'smooth' }); }
            else { slider.scrollTo({ left: slider.offsetWidth * slideIndex, behavior: 'smooth' }); }
        }, 5000);

        function preloadImages() {
            const urls = [];
            products.forEach(p => { urls.push(p.image); if(p.colors) p.colors.forEach(c=>urls.push(c.image)); if(p.realPhotos) urls.push(...p.realPhotos); });
            if(urls.length===0) showApp();
            let c=0; urls.forEach(u=>{ const i=new Image(); i.src=u; i.onload=i.onerror=()=>{c++; if(c===urls.length) showApp();}});
        }
        function showApp() { document.getElementById('preloader').style.display='none'; document.getElementById('app-content').style.opacity='1'; checkAuth(); }
        
        preloadImages();
        renderProducts();
    </script>
</body>
</html>
